## Coding UK Biobank Mortality According to Cause of Death 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(results = 'hide')
knitr::opts_chunk$set(eval =  FALSE)
```

Below shows the code used to classify chronic disease mortality using the UK Biobank dataset. Deaths were classified as related to a chronic disease if either the primary or one of the contributory causes of death was listed as a chronic disease. The code below uses the following ICD-10 codes to classify chronic disease mortality: 
<br />  
Chronic disease categories (ICD-10 codes):  

* Malignant neoplasms (C00–C97)  
* Diabetes mellitus (E10–E14)  
* Heart diseases and hypertension (I00–I15,I20–I51)   
* Cerebrovascular diseases (I60–I69)  
* Chronic lower respiratory diseases (J40–J47)  
* Chronic liver diseases and cirrhosis (K70, K73-K74)  
* Chronic kidney disease (N18)
* Neurodegenerative diseases  
  + Dementia (F00-F03; G31)
  + Motor neuron disease (G12.2)
  + Parkinson's (G20-G22)
  + Alzheimer's (G30)
  + MS (G35)
<br />  

```{css, echo=FALSE}

# this is supposed to be css code to make code chunks appear in scrollable boxes

pre {
  max-height: 800px;
  overflow-y: auto;
}

pre[class] {
  max-height: 800px;
}
```

### Coding ICD-10 chronic disease codes
<br />  
```{r ICD, results='hide', eval=FALSE}

# import list of ICD-10 codes from UKB website: https://biobank.ctsu.ox.ac.uk/crystal/coding.cgi?id=19&nl=1 
library(readr)
ICD10list3d <- read_delim("/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/6. Outcome data/icd10_coding19.tsv", 
    "\t", 
    escape_double = FALSE, 
    trim_ws = TRUE)

# make character vector with just ICD codes
ICD10list3d <- as.vector(ICD10list3d$coding)

### defining chronic diseases by ICD 10 codes. ICD groupings taken from here: https://www.cdc.gov/nchs/data/nvsr/nvsr68/nvsr68_09-508.pdf; https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6843938/; https://www.nejm.org/doi/10.1056/NEJMoa1908483?url_ver=Z39.88-2003&rfr_id=ori:rid:crossref.org&rfr_dat=cr_pub%20%200pubmed; https://www.sciencedirect.com/science/article/pii/S0160412019337171?via%3Dihub

# malignant neoplasms C00–C97
prefix <- "C"
suffix <- sprintf('%0.2d', 1:9)
seq <- paste0(prefix, suffix)

prefix <- "C"
suffix <- seq(10,97)
seq2 <- paste0(prefix, suffix)

prefix <- "C"
suffix <- sprintf('%0.3d', 0:9)
seq3 <- paste0(prefix, suffix)

prefix <- "C0"
suffix <- sprintf('%0.d', 10:99)
seq4 <- paste0(prefix, suffix)

prefix <- "C"
suffix <- seq(100,979)
seq5 <- paste0(prefix, suffix)

neoplasm <- c("C00", 
              seq, 
              seq2, 
              seq3, 
              seq4, 
              seq5)
neoplasm_icd <- ICD10list3d[which(ICD10list3d %in% neoplasm)]


# diabetes mellitus E10–E14 
prefix <- "E"
suffix <- seq(10,14)
seq <- paste0(prefix, suffix)

prefix <- "E"
suffix <- seq(100,149)
seq2 <- paste0(prefix, suffix)

diabetes <- c(seq, 
              seq2)
diabetes_icd <- ICD10list3d[which(ICD10list3d %in% diabetes)]


# heart diseases and hypertension (I00–I15,I20–I51) # can just be coded 0 - 51 because there are no codes between 15-20
prefix <- "I"
suffix <- sprintf('%0.2d', 1:9)
seq <- paste0(prefix, suffix)

prefix <- "I"
suffix <- seq(10,51)
seq2 <- paste0(prefix, suffix)

prefix <- "I"
suffix <- sprintf('%0.3d', 0:9)
seq3 <- paste0(prefix, suffix)

prefix <- "I0"
suffix <- sprintf('%0.d', 10:99)
seq4 <- paste0(prefix, suffix)

prefix <- "I"
suffix <- seq(100,519)
seq5 <- paste0(prefix, suffix)

cardio <- c("I00", 
            seq, 
            seq2, 
            seq3, 
            seq4, 
            seq5)
cardio_icd <- ICD10list3d[which(ICD10list3d %in% cardio)]


#cerebrovascular disease I60–I69
prefix <- "I"
suffix <- seq(60,69)
seq <- paste0(prefix, suffix)

prefix <- "I"
suffix <- seq(600,699)
seq2 <- paste0(prefix, suffix)

cerebro <- c(seq, 
             seq2)
cerebro_icd <- ICD10list3d[which(ICD10list3d %in% cerebro)]


#chronic lower respiratory disease (J40–J47)
prefix <- "J"
suffix <- seq(40,47)
seq <- paste0(prefix, suffix)

prefix <- "J"
suffix <- seq(400,479)
seq2 <- paste0(prefix, suffix)

copd <- c(seq, 
          seq2)
copd_icd <- ICD10list3d[which(ICD10list3d %in% copd)]


# chronic liver disease (K70, K73-K74)
prefix <- "K"
suffix <- seq(73,74)
seq <- paste0(prefix, suffix)

prefix <- "K"
suffix <- seq(700,709)
seq2 <- paste0(prefix, suffix)

prefix <- "K"
suffix <- seq(730,749)
seq3 <- paste0(prefix, suffix)

liver <- c("K70", 
           seq, 
           seq2, 
           seq3)
liver_icd <- ICD10list3d[which(ICD10list3d %in% liver)]


# chronic kidney disease (N18)
prefix <- "N"
suffix <- seq(180,189)
seq <- paste0(prefix, suffix)

kidney <- c("N18",
             seq)
kidney_icd <- ICD10list3d[which(ICD10list3d %in% kidney)]


# neurodegenerative disease [ dementia (F00-F03; G31), motor neuron disease (G12.2), Parkinson's (G20-G22), Alzheimer's (G30),  MS (G35)]
prefix <- "F"
suffix <- sprintf('%0.2d', 1:3)
seq <- paste0(prefix, suffix)

prefix <- "F"
suffix <- sprintf('%0.3d', 0:9)
seq2 <- paste0(prefix, suffix)

prefix <- "F0"
suffix <- sprintf('%0.d', 10:39)
seq3 <- paste0(prefix, suffix)

prefix <- "I"
suffix <- seq(100,519)
seq5 <- paste0(prefix, suffix)

prefix <- "G"
suffix <- seq(310,319)
seq5 <- paste0(prefix, suffix)

prefix <- "G"
suffix <- seq(20,22)
seq6 <- paste0(prefix, suffix)

prefix <- "G"
suffix <- seq(200,229)
seq7 <- paste0(prefix, suffix)

prefix <- "G"
suffix <- seq(300,309)
seq8 <- paste0(prefix, suffix)

prefix <- "G"
suffix <- seq(350,359)
seq9 <- paste0(prefix, suffix)

neurodegen <- c("F00", 
                seq, 
                seq2, 
                seq3, 
                "G31", 
                seq5, 
                "G122", 
                seq6, 
                seq7, 
                "G30", 
                seq8, 
                "G35", 
                seq9)

neurodegen_icd <- ICD10list3d[which(ICD10list3d %in% neurodegen)]


# create list of all NCD codes
icd_include <- c(neoplasm_icd,
                 diabetes_icd,
                 cardio_icd,
                 cerebro_icd,
                 copd_icd,
                 liver_icd,
                 kidney_icd,
                 neurodegen_icd)
```
<br />  

### Importing mortality data
<br />  
``` {r mortality, results='hide'}
library(readr)
library(tidyr)
library(dplyr)   

### import mortality data

# date of death data
dat_long <- read_delim("/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/6. Outcome data/updated_mortality_july_21.txt",
    "\t", 
    escape_double = FALSE, 
    trim_ws = TRUE)

# cause of death (COD) data. More info here: http://biobank.ndph.ox.ac.uk/showcase/showcase/docs/DeathLinkage.pdf.
dat_COD <- read_delim("/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/6. Outcome data/updated_mortality_cause_july_21.txt", # cause of death table. 
    "\t", 
    escape_double = FALSE, 
    trim_ws = TRUE)


### transform COD data from long format (with multiple rows per eid) 
### to wide format (multiple columns and one row per eid)
dat_COD <- pivot_wider(dat_COD,
                       names_from = c(ins_index, 
                                      arr_index), # any new value in "ins_index" or "arr_index" becomes a new column
                       values_from = cause_icd10) # populate new columns with corresponding value from cause of death column

dat_COD <- subset(dat_COD, 
                  select = -c(level)) # remove level variable (it's redundant to the arr_index information)

### the dataset now has two rows for each eid: 
### instance index = 0 COD data are all in one row and instance = 1 are all on second
### collapse the two rows for each eid into one row

# prepare dataset
dat_COD <- sapply(dat_COD, as.character) # data need to be characters for transpose function
dat_COD[is.na(dat_COD)] <- "" # NA values will cause errors in the transpose
dat_COD <- as.data.frame(dat_COD) # convert back to df

# transpose dataset by merging all rows with a unique eid into one row
dat_COD %>% 
  group_by(eid) %>% 
  summarise_all(funs(
    trimws(
      paste(., 
            collapse = "")))) -> dat_COD

dat_COD[dat_COD == ""] <- NA # convert empty cells back to NA

### replace column names

# new column names
prefix <- "cause_icd.0."
suffix <- seq(0,14)
ICD10_0 <- paste0(prefix, suffix)

# old names to replace
prefix <- "0_"
suffix <- seq(0,14)
replace1 <- paste0(prefix, suffix)

# new column names
prefix <- "cause_icd.1."
suffix <- seq(0,9)
ICD10_1 <- paste0(prefix, suffix)

# old names to replace
prefix <- "1_"
suffix <- seq(0,9)
replace2 <- paste0(prefix, suffix)

# loop to replace instance 0 column names
for(j in seq_along(replace1)){
  names(dat_COD)[names(dat_COD) == replace1[j]] <- ICD10_0[j]
}

# loop to replace instance 1 column names
for(j in seq_along(replace2)){
  names(dat_COD)[names(dat_COD) == replace2[j]] <- ICD10_1[j] 
}

# reorder columns in ascending order
col_order <- c("eid", ICD10_0, ICD10_1)
dat_COD <- dat_COD[, col_order]


### prepare death date data 

# remove duplicate date record row for any participant (e.g., where "ins_index = 1"). 
# date in ins_index = 1 shows the same date so it is redundant
dat_long <- dat_long[which(dat_long$ins_index=='0'), ]

dat_long <- subset(dat_long, 
                   select = -c(ins_index, 
                               dsource, 
                               source)) # remove these three columns


### merge date of death and COD data frames
long <- merge(dat_COD, 
              dat_long, 
              by = "eid", 
              all = FALSE) # Note: this will delete 10 participants that have a date of death but no cause of death information

```

``` {r charlson, results='hide', include=FALSE, eval=FALSE}

### import charlson comorbidity index for exclusions
charlson <- readRDS("/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/5. Recoded datasets/ukb_charlson_comorbidity_index_baseline.rds")

# merge baseline charlson dataset (full cohort) with mortality data
long <- merge(long, 
              charlson, 
              by.x = "eid", 
              by.y = "f.eid", 
              all = TRUE)
```
<br />  

### Creating event indicators based on ICD-10 codes
<br />  
``` {r NCD, results='hide'}

### re-coding date of death

# set non-NCD death dates to NA (primary cause)
long$date_of_death_NCD_primary <- ifelse(long$cause_icd.0.0 %in% icd_include | # if primary ICD diagnosis (ins 0) is in NCD include list OR
                                           long$cause_icd.1.0 %in% icd_include, # if primary ICD diagnosis (ins 1) is in include list
                                         long$date_of_death, # keep as date of death
                                         NA) # or else assign NA


# set non-NCD death dates to NA (primary or secondary cause)
long$date_of_death_NCD_all <- ifelse(long$cause_icd.0.0 %in% icd_include | 
                                       long$cause_icd.0.1 %in% icd_include | 
                                       long$cause_icd.0.2 %in% icd_include | 
                                       long$cause_icd.0.3 %in% icd_include | 
                                       long$cause_icd.0.4 %in% icd_include | 
                                       long$cause_icd.0.5 %in% icd_include | 
                                       long$cause_icd.0.6 %in% icd_include | 
                                       long$cause_icd.0.7 %in% icd_include | 
                                       long$cause_icd.0.8 %in% icd_include | 
                                       long$cause_icd.0.9 %in% icd_include |
                                       long$cause_icd.0.10 %in% icd_include | 
                                       long$cause_icd.0.11 %in% icd_include | 
                                       long$cause_icd.0.12 %in% icd_include | 
                                       long$cause_icd.0.13 %in% icd_include | 
                                       long$cause_icd.0.14 %in% icd_include | 
                                       long$cause_icd.1.0 %in% icd_include | 
                                       long$cause_icd.1.1 %in% icd_include | 
                                       long$cause_icd.1.2 %in% icd_include | 
                                       long$cause_icd.1.3 %in% icd_include | 
                                       long$cause_icd.1.4 %in% icd_include | 
                                       long$cause_icd.1.5 %in% icd_include | 
                                       long$cause_icd.1.6 %in% icd_include | 
                                       long$cause_icd.1.7 %in% icd_include | 
                                       long$cause_icd.1.8 %in% icd_include | 
                                       long$cause_icd.1.9 %in% icd_include,
                                     long$date_of_death, # keep as date of death
                                     NA) # or else assign NA

### coding event indicators

# event indicator for all-cause mortality
library(car)
long$event_indicator <- long$date_of_death
long$event_indicator[which(is.na(long$event_indicator))] <- 0 # recode all NAs as 0

long$event_indicator <- recode(long$event_indicator, 
                               "'0' = '0'; 
                               else = '1'") # any date of death is coded as 1

# event indicator for NCD primary cause of death
long$event_indicator_NCD_primary <- ifelse(!is.na(long$date_of_death_NCD_primary),
                                         1, # assign a 1
                                         0) # or else assign a 0

# event indicator for NCD any cause of death
long$event_indicator_NCD_all <- ifelse(!is.na(long$date_of_death_NCD_all),
                                       1,
                                       0)

# reformat as date
long$date_of_death <- as.Date(long$date_of_death, 
                              format = "%d/%m/%y")

long$date_of_death_NCD_primary <- as.Date(long$date_of_death_NCD_primary, 
                                          format = "%d/%m/%y")

long$date_of_death_NCD_all <- as.Date(long$date_of_death_NCD_all, 
                                      format = "%d/%m/%y")

# save mortality dataset
saveRDS(long, file = "/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/6. Outcome data/ukb_mortality_and comorbidity.rds") # save RDS to file

```

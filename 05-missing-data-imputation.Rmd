# Missing data imputation

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(results = 'asis')
knitr::opts_chunk$set(fig.align='center')
```

```{r import_imp, results='hide'}
library(mice)
library(survival)
library(Hmisc)
library(summarytools)
library(missRanger)
library(plotly)

dat <- readRDS("/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/5. Recoded datasets/ukb_full_recoded_dataset.rds")
mort <- readRDS("/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/6. Outcome data/ukb_mortality_and comorbidity.rds")
mort <- subset(mort, select = c(Cs(eid,
                                   date_of_death,
                                   date_of_death_NCD_primary,
                                   date_of_death_NCD_all,
                                   event_indicator,
                                   event_indicator_NCD_primary,
                                   event_indicator_NCD_all
                                   )))

# remove participants who requested to be removed from UK Biobank analyses
# (eids sent in Aug 23, 2020 and January 2021 emails from UKB)
eid_remove <- c(
  Cs(
    1118928,
    1189363,
    1520532,
    1926850,
    2145109,
    2224549,
    2627502,
    3007346,
    3195734,
    3286603,
    3585254,
    3777213,
    3845241,
    4189779,
    4738692,
    5133093
  )
)

dat <- dat[which(dat$eid %nin% eid_remove), ]
mort <- mort[which(mort$eid %nin% eid_remove), ]
```

## Creating mortality event indicators and cumulative hazard for imputation
```{r indicators, results='hide'}

# create censoring date for those still alive, using UKB's suggested date of April 30, 2020
# UKB guidance on censoring date: http://biobank.ndph.ox.ac.uk/showcase/exinfo.cgi?src=Data_providers_and_dates

# censor date is any death, regardless of whether it was an NCD death
mort$censor_date <- mort$date_of_death 

# add in censor date to those who are still alive (death date = NA)
mort$censor_date[is.na(mort$censor_date)] <- "2020-4-30" 

# create dataset with just recruitment date
d.merge <- subset(dat, 
                  select = c("eid", 
                             "recruitment_date"))

# add recruitment date to mortality df
mort <- merge(mort, 
              d.merge, 
              by = "eid", 
              all = TRUE)

# create survival time variable (censoring date - recruitment date)
mort$survival_time <- (mort$censor_date - mort$recruitment_date)

# create nelson aalen estimator (cumulative hazard rate). Note: needs event indicator to be numeric and not a factor
mort$hazard <- nelsonaalen(mort, # dataset
                           survival_time, # survival time
                           event_indicator_NCD_all) # event indicator

# 3 outcome variables needed to add to exposure dataset before imputation: nelson aalen, survival time, and event indicator. 
mort <- subset(mort, 
               select = c(Cs(eid,
                             hazard,
                             survival_time,
                             event_indicator_NCD_all
               ))) 

# merge full dataset with survival outcome data
dat <- merge(dat, 
             mort, 
             by = "eid", 
             all = TRUE) 
```

## Participant exclusions

```{r subset_datasets, results='hide'}

### subset dataset to England participants only 

# vector of recruitment centres from scotland & wales
scot_wales <- c("11005", # edinburgh
                "11004", # glasgow
                "11003", # cardiff
                "11023", # wrexham
                "11022") # swansea
scot_wales <- as.vector(scot_wales)

#subset to just england participants
dat_eng <- dat[which(dat$recruitment_centre %nin% scot_wales), ]
table(dat_eng$recruitment_centre) # check

# check sample sizes after removing participants 
paste("n removed excluding non-England:", (nrow(dat) - nrow(dat_eng)))

# remove empty recruitment centre response levels
levels <- levels(dat_eng$recruitment_centre)
england <- levels[levels %nin% scot_wales]
dat_eng$recruitment_centre <- factor(dat_eng$recruitment_centre, 
                                     levels = c(england),
                                     ordered = FALSE)

# remove levels with no responses for home population density after removing non-England participants
table(dat_eng$home_population_density)
levels <- levels(dat_eng$home_population_density)
scot <- c("Postcode not linkable",
          "Scotland - Large Urban Area",
          "Scotland - Other Urban Area",
          "Scotland - Accessible Small Town",
          "Scotland - Remote Small Town",
          "Scotland - Accessible Rural",
          "Scotland - Remote Rural",
          "Scotland - Very Remote Rural")
england <- levels[levels %nin% scot]
dat_eng$home_population_density <- factor(dat_eng$home_population_density, 
                                          levels = c(england), 
                                          ordered = FALSE)

rows1 <- nrow(dat_eng)

### subset dataset to only those that weren't adopted
dat_eng <- dat_eng[which(dat_eng$adopted == "No"), ]

rows2 <- nrow(dat_eng)

# check sample sizes after removing adopted participants 
paste("n removed excluding adopted:", (rows1 - rows2))

### recoding pack years (it's a nested variable) so that those who answered never to smoking status have a 0 instead of NA
dat_eng$pack_years <- ifelse(!is.na(dat_eng$pack_years), 
                             dat_eng$pack_years, 
                             ifelse(dat_eng$smoking_status == "Never", 
                                    0,
                                    NA))


dat_eng$pack_years_prop <- ifelse(!is.na(dat_eng$pack_years_prop), 
                                  dat_eng$pack_years_prop,
                                  ifelse(dat_eng$smoking_status == "Never",
                                         0,
                                         NA))

```

``` {r male_female, results='hide'}                                          
                                          
### create male and female datasets
mdat <- dat_eng[which(dat_eng$sex == "Male"), ]
fdat <- dat_eng[which(dat_eng$sex == "Female"), ]

```

```{r repro_recode, results='hide'}

### recode some nested female reproduction variables 
### I want to keep for later analyses and don't want excluded in the next step

fdat$menopause_age <- ifelse(!is.na(fdat$menopause_age),
                             fdat$menopause_age, # if it is not NA, then keep the value
                             ifelse(is.na(fdat$menopause) |
                                      fdat$menopause == "No", 
                                    777, # else if response to menopause is NA or no, code nested missing as 777
                                    NA)) # or else NA (i.e., response to menopause is 1, but the response to menopause age is truly missing)
fdat$menopause_age <- as.numeric(fdat$menopause_age)

fdat$birth_age <- ifelse(!is.na(fdat$birth_age),
                         fdat$birth_age,
                         ifelse(is.na(fdat$number_births) |
                                  fdat$number_births != 1,
                                777,
                                NA))
fdat$birth_age <- as.numeric(fdat$birth_age)

fdat$first_birth_age <- ifelse(!is.na(fdat$first_birth_age), 
                               fdat$first_birth_age,
                               ifelse(is.na(fdat$number_births) |
                                        fdat$number_births == 1, 
                                      777,
                                      NA))
fdat$first_birth_age <- as.numeric(fdat$first_birth_age)

fdat$last_birth_age <- ifelse(!is.na(fdat$last_birth_age),
                              fdat$last_birth_age,
                              ifelse(is.na(fdat$number_births) |
                                       fdat$number_births == 1,
                                     777,
                                     NA))
fdat$last_birth_age <- as.numeric(fdat$last_birth_age)
```

## Excuding variables missing in >80% of participants. 

``` {r missing, results='hide'}

# remove variable columns with >80% missing
mdat_nomiss <- mdat[ ,which(colMeans(is.na(mdat)) < 0.8)] 
fdat_nomiss <- fdat[ ,which(colMeans(is.na(fdat)) < 0.8)]

```

## Removing nested variables

``` {r nested, results='hide'}

### remove all nested variables 

# create csv files of all column names to scan for nested variables
mcols <- colnames(mdat_nomiss)
fcols <- colnames(fdat_nomiss)

write.csv(mcols, file = "/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Output/male_check_for_nested.csv")
write.csv(fcols, file = "/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Output/female_check_for_nested.csv")

# list of all nested variables
nested <- c(Cs(glasses_age,
               MI_diagnosis_age,
               angina_diagnosis_age,
               stroke_diagnosis_age,
               bp_diagnosis_age,
               DVT_diagnosis_age,
               pulm_embolism_diagnosis_age,
               emphysema_diagnosis_age,
               asthma_diagnosis_age,
               rhinitis_diagnosis_age,
               gest_diabetes_only,
               diabetes_diagnosis_age,
               diabetes_insulin_1yr,
               myopia_eye,
               hypertropia_eye,
               presbyopia_eye,
               astigmatism_eye,
               strabismus_eye,
               amblyopia_eye,
               other_eye,
               other_serious_eye,
               diabetes_eye,
               glaucoma_eye,
               injury_eye,
               cataract_eye,
               macular_degeneration_eye,
               diabetes_eye_age,
               glaucoma_age,
               injury_eye_age,
               cataract_age,
               macular_degeneration_age,
               other_serious_eye_age,
               bowel_cancer_screening_recent,
               PSA_test_time_since,
               light_smoking,
               smoking_start_age_former,
               tobacco_type_previous,
               number_cigarettes_previous,
               smoking_stop_age,
               ever_stop_smoking_6months,
               number_quit_attempts,
               light_smoking,
               smoking_start_age_current,
               tobacco_type,
               previous_smoker,
               number_cigarettes,
               cigarettes_stop_age,
               previous_number_cigarettes,
               waking_smoke_time,
               difficulty_not_smoking_1day,
               stop_smoking_attempt,
               stop_smoking_desire,
               smoking_10yrs,
               smoking_start_age_former,
               tobacco_type_previous,
               number_cigarettes_previous,
               smoking_stop_age,
               ever_stop_smoking_6months,
               number_quit_attempts,
               alcohol_former,
               red_wine_monthly,
               white_wine_monthly,
               beer_monthly,
               spirits_monthly,
               fortified_wine_monthly,
               other_alcohol_monthly,
               red_wine_weekly,
               white_wine_weekly,
               beer_weekly,
               spirits_weekly,
               fortified_wine_weekly,
               other_alcohol_weekly,
               alcohol_with_meals,
               alcohol_10yrs,
               reason_reducing_alcohol,
               reason_stopped_alcohol,
               glasses_myopia,
               glasses_presbyopia,	
               glasses_hypermetropia,	
               glasses_amblyopia,	
               glasses_astigmatism,	
               glasses_strabismus,	
               glasses_other,
               glaucoma,
               headaches_3months,
               facial_pain_3months,
               neck_pain_3months,
               stomach_pain_3months,
               hip_pain_3months,
               knee_pain_3months,
               general_pain_3months,
               chest_pain_walking_normal,
               chest_pain_ceases_still,
               chest_pain_walking_uphill,
               father_age,
               father_age_death,
               mother_age,
               mother_age_death,
               heavy_DIY_duration,
               light_DIY_duration,
               moderate_activity_duration,
               other_exercise_duration,
               strenuous_sports_duration,
               vigorous_activity_duration,
               walks_duration,
               pleasure_walks_duration,
               heavy_DIY_freq_4wks,
               light_DIY_freq_4wks,
               other_exercise_freq_4wks,
               stair_climbing_freq_4wks,
               strenuous_sports_freq_4wks,
               pleasure_walks_freq_4wks,
               menstruating_today,
               oral_contraceptive_age_first,
               oral_contraceptive_age_last,
               HRT_age_first,
               HRT_age_last,
               hysterectomy_age,
               bilateral_oophorectomy_age,
               mammogram_years_since,
               cervical_smear_years_since,
               first_child_birth_weight,
               number_stillbirths,
               number_miscarriages,
               number_pregnancy_terminations,
               period_time_since,
               resume_smoking_likelihood,
               stopped_smoking_health,
               stopped_smoking_illness,
               stopped_smoking_financial,
               stopped_smoking_doctor,
               reduced_smoking_health,
               reduced_smoking_illness,
               reduced_smoking_financial,
               reduced_smoking_doctor,
               education_age_complete,
               country_birth_non_UK
))

# remove all columns with nested variables
mdat_nonest <- mdat_nomiss[ ,which(colnames(mdat_nomiss) %nin% nested)] 
fdat_nonest <- fdat_nomiss[ ,which(colnames(fdat_nomiss) %nin% nested)] 

rows1 <- nrow(mdat_nonest)
rows2 <- nrow(fdat_nonest)

# remove participant rows who still have >80% missing after excluding nested vars
mdat_nonest <- mdat_nonest[which(rowMeans(is.na(mdat_nonest)) < 0.8), ]
fdat_nonest <- fdat_nonest[which(rowMeans(is.na(fdat_nonest)) < 0.8), ] 

rows3 <- nrow(mdat_nonest)
rows4 <- nrow(fdat_nonest)

# check sample sizes after removing vars 
paste("n removed excluding missing >80% of vars - men:", rows1 - rows3)
paste("n removed excluding missing >80% of vars - women:", rows2 - rows4)
paste("n removed excluding missing >80% of vars:", (rows1 + rows2) - (rows3 + rows4))

```

## Participant exclusions based on Charlson comorbidity index and previous diagnoses

```{r}
### performing exclusions based on charlson comorbidity index and previous diagnoses

# load charlson dataset
charlson <- readRDS("/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/5. Recoded datasets/ukb_charlson_comorbidity_index_baseline.rds")

# subset just to index score
charlson <- subset(charlson, select = c("f.eid", "index"))

# merge charlson information with datasets
mdat_charlson <- merge(mdat_nonest, 
                       charlson, 
                       by.x = "eid", 
                       by.y = "f.eid", 
                       all = FALSE, 
                       sort = FALSE)

fdat_charlson <- merge(fdat_nonest, 
                       charlson, 
                       by.x = "eid", 
                       by.y = "f.eid", 
                       all = FALSE, 
                       sort = FALSE)

# exclude those with charlson index > 0 
mdat_charlson <- mdat_charlson[which(mdat_charlson$index == 0), ]
fdat_charlson <- fdat_charlson[which(fdat_charlson$index == 0), ]

# count number excluded from charlson
paste("men excluded charlson:", nrow(mdat_nonest) - nrow(mdat_charlson)) 
paste("women excluded charlson:", nrow(fdat_nonest) - nrow(fdat_charlson)) 
paste("total excluded charlson:", (nrow(mdat_nonest) + nrow(fdat_nonest)) - 
        (nrow(mdat_charlson) + nrow(fdat_charlson)))


## excluding based on previous diagnoses in men

# exclude those with previous bronchitis/emphysema diagnosis
mdat_final <- mdat_charlson[which(mdat_charlson$bronchitis_emphysema_diagnosis == "No"), ]
# exclude those with previous cancer diagnosis
mdat_final <- mdat_final[which(mdat_final$cancer_diagnosis == "No"), ]
# exclude those with previous diabetes diagnosis
mdat_final <- mdat_final[which(mdat_final$diabetes_diagnosis == "No"), ]
# exclude those with previous MI diagnosis
mdat_final <- mdat_final[which(mdat_final$heart_attack_diagnosis == "No"), ]
# exclude those with previous stroke diagnosis
mdat_final <- mdat_final[which(mdat_final$stroke_diagnosis == "No"), ]

## excluding based on previous diagnoses in women

# exclude those with previous bronchitis/emphysema diagnosis
fdat_final <- fdat_charlson[which(fdat_charlson$bronchitis_emphysema_diagnosis == "No"), ]
# exclude those with previous cancer diagnosis
fdat_final <- fdat_final[which(fdat_final$cancer_diagnosis == "No"), ]
# exclude those with previous diabetes diagnosis
fdat_final <- fdat_final[which(fdat_final$diabetes_diagnosis == "No"), ]
# exclude those with previous MI diagnosis
fdat_final <- fdat_final[which(fdat_final$heart_attack_diagnosis == "No"), ]
# exclude those with previous stroke diagnosis
fdat_final <- fdat_final[which(fdat_final$stroke_diagnosis == "No"), ]

# count number excluded from diagnoses
paste("men excluded diagnoses:", nrow(mdat_charlson) - nrow(mdat_final))
paste("women excluded diagnoses:", nrow(fdat_charlson) - nrow(fdat_final))
paste("total excluded diagnoses:", (nrow(mdat_charlson) + nrow(fdat_charlson)) - 
        (nrow(mdat_final) + nrow(fdat_final))) 

# check final sample sizes
paste("final men analytic sample:", nrow(mdat_final))
paste("final women analytic sample:", nrow(fdat_final))
paste("final total analytic sample:", nrow(mdat_final) + nrow(fdat_final))

# check exclusions - the # of yes responses should be 0
dfSummary(mdat_final$cancer_diagnosis)
dfSummary(fdat_final$cancer_diagnosis)
```

``` {r save_exclusions, eval=FALSE}
# save after also excluding all nested variables except select female reproduction vars

mdat_final <- subset(mdat_final, 
                     select = -c(index,
                                 bronchitis_emphysema_diagnosis,
                                 cancer_diagnosis,
                                 diabetes_diagnosis,
                                 heart_attack_diagnosis,
                                 stroke_diagnosis,
                                 adopted))

fdat_final <- subset(fdat_final, 
                     select = -c(index,
                                 bronchitis_emphysema_diagnosis,
                                 cancer_diagnosis,
                                 diabetes_diagnosis,
                                 heart_attack_diagnosis,
                                 stroke_diagnosis,
                                 adopted))

save(mdat_final, fdat_final, file = "/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/7. Imputation/final_datasets_england_nomiss_nonest_noadopt_exclusions.RData")

```

## Imputation by random forest and predictive mean matching

```{r imputation, eval=FALSE}

# more instructions here: https://cran.r-project.org/web/packages/missRanger/vignettes/vignette_missRanger.html
load("/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/7. Imputation/final_datasets_england_nomiss_nonest_noadopt_exclusions.RData")

### men

# create case weights to weight down the contribution of rows with many missings during the imputation
non_miss <- rowSums(!is.na(mdat_final))

# multiple imputation in men
mult <- lapply(123:127, function(x) missRanger(mdat_final, 
                                               . ~ . - survival_time - 
                                                 eid - 
                                                 sex - 
                                                 childhood_hate -
                                                 childhood_love -
                                                 childhood_doctor -
                                                 childhood_physical_abuse -
                                                 childhood_sex_abuse, # do not use to predict
                                               maxiter = 10, 
                                               pmm.k = 3,
                                               verbose = 1, 
                                               seed = x,
                                               num.trees = 200, 
                                               returnOOB = TRUE,
                                               case.weights = non_miss))


save(mult, file = "/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/8. Final imputed exposure datasets/missRAnger_multiple_imputation_output_200t.RData")


### women

# create case weights to weight down the contribution of rows with many missings during the imputation
non_miss <- rowSums(!is.na(fdat_final))

fmult <- lapply(123:127, function(x) missRanger(fdat_final, 
                                                . ~ . - survival_time - 
                                                  eid - 
                                                  sex - 
                                                  childhood_hate -
                                                  childhood_love -
                                                  childhood_doctor -
                                                  childhood_physical_abuse -
                                                  childhood_sex_abuse -
                                                  menopause_age - 
                                                  birth_age - 
                                                  first_birth_age - 
                                                  last_birth_age, # do not use to predict for imputation
                                                maxiter = 10, 
                                                pmm.k = 3,
                                                verbose = 1, 
                                                seed = x,
                                                num.trees = 200, 
                                                returnOOB = TRUE,
                                                case.weights = non_miss))

save(fmult, file = "/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/8. Final imputed exposure datasets/missRAnger_multiple_imputation_output_female_200t.RData")
```

## Creating derived variables

``` {r}
load("/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/8. Final imputed exposure datasets/missRAnger_multiple_imputation_output_200t.RData")
load("/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/8. Final imputed exposure datasets/missRAnger_multiple_imputation_output_female_200t.RData")

### loop to create derived variables in each of the 5 imputed datasets

### men

for(j in seq_along(mult)){  
  # create empty columns for new derived variables
mult[[j]]$sleep_hours_categorical <- NA
mult[[j]]$education_years <- NA
mult[[j]]$hand_grip_strength_left_normalized <- NA
mult[[j]]$hand_grip_strength_right_normalized <- NA
mult[[j]]$FEV1_standardized <- NA
mult[[j]]$FVC_standardized <- NA

mult[[j]]$sleep_hours_categorical <- factor(mult[[j]]$sleep_hours_categorical, 
                                            ordered = FALSE)

mult[[j]]$education_years <- factor(mult[[j]]$education_years, 
                                    ordered = FALSE)

mult[[j]]$hand_grip_strength_left_normalized <- 
  as.numeric(mult[[j]]$hand_grip_strength_left_normalized)

mult[[j]]$hand_grip_strength_right_normalized <- 
  as.numeric(mult[[j]]$hand_grip_strength_right_normalized)

mult[[j]]$FEV1_standardized <- as.numeric(mult[[j]]$FEV1_standardized)
mult[[j]]$FVC_standardized <- as.numeric(mult[[j]]$FVC_standardized)

# sleep hours categorical
mult[[j]]$sleep_hours_categorical <- ifelse(mult[[j]]$sleep_hours < 7, 
                                            '<7 hours', 
                                            ifelse(mult[[j]]$sleep_hours >= 7 & mult[[j]]$sleep_hours <= 9, 
                                                   '7-9 hours',
                                                   '>9 hours'))

mult[[j]]$sleep_hours_categorical <- factor(mult[[j]]$sleep_hours_categorical, 
                                            levels = c('<7 hours',
                                                       '7-9 hours',
                                                       '>9 hours'),
                                            ordered = FALSE)

mult[[j]]$sleep_hours_categorical <- relevel(mult[[j]]$sleep_hours_categorical, ref = '7-9 hours')

# education years
mult[[j]]$education_years <- ifelse(mult[[j]]$education_college == 'Yes', 
                                    '20 years', 
                               ifelse(mult[[j]]$education_NVQ == 'Yes', 
                                      '19 years', 
                                      ifelse(mult[[j]]$education_other_professional == 'Yes', 
                                             '15 years', 
                                             ifelse(mult[[j]]$education_A_levels == 'Yes', 
                                                    '13 years', 
                                                    ifelse(mult[[j]]$education_O_levels == 'Yes' | mult[[j]]$education_CSEs == 'Yes', 
                                                           '10 years',
                                                           ifelse(mult[[j]]$education_none == 'Yes', 
                                                                  '7 years', 
                                                                  '7 years'))))))

mult[[j]]$education_years <- factor(mult[[j]]$education_years, 
                                    levels = c('7 years',
                                               '10 years',
                                               '13 years',
                                               '15 years',
                                               '19 years',
                                               '20 years'),
                                    ordered = FALSE)

mult[[j]]$education_years <- relevel(mult[[j]]$education_years, 
                                     ref = '7 years')

# hand grip strength normalized by body weight
mult[[j]]$hand_grip_strength_left_normalized <- 
  (mult[[j]]$hand_grip_strength_left / mult[[j]]$weight)

mult[[j]]$hand_grip_strength_right_normalized <- 
  (mult[[j]]$hand_grip_strength_right / mult[[j]]$weight)

# lung function standardized by height
mult[[j]]$FEV1_standardized <- 
  (mult[[j]]$FEV1_best / (mult[[j]]$standing_height / 100)^2) # divide by 100 to get m instead of cm

mult[[j]]$FVC_standardized <- 
  (mult[[j]]$FVC_best / (mult[[j]]$standing_height / 100)^2) # divide by 100 to get m instead of cm

}


### women
for(j in seq_along(fmult)){  
  # create empty columns for new derived variables
fmult[[j]]$sleep_hours_categorical <- NA
fmult[[j]]$education_years <- NA
fmult[[j]]$hand_grip_strength_left_normalized <- NA
fmult[[j]]$hand_grip_strength_right_normalized <- NA
fmult[[j]]$FEV1_standardized <- NA
fmult[[j]]$FVC_standardized <- NA

fmult[[j]]$sleep_hours_categorical <- factor(fmult[[j]]$sleep_hours_categorical, 
                                             ordered = FALSE)

fmult[[j]]$education_years <- factor(fmult[[j]]$education_years, 
                                     ordered = FALSE)

fmult[[j]]$hand_grip_strength_left_normalized <- 
  as.numeric(fmult[[j]]$hand_grip_strength_left_normalized)

fmult[[j]]$hand_grip_strength_right_normalized <- 
  as.numeric(fmult[[j]]$hand_grip_strength_right_normalized)

fmult[[j]]$FEV1_standardized <- as.numeric(fmult[[j]]$FEV1_standardized)
fmult[[j]]$FVC_standardized <- as.numeric(fmult[[j]]$FVC_standardized)

# sleep hours categorical
fmult[[j]]$sleep_hours_categorical <- ifelse(fmult[[j]]$sleep_hours < 7, 
                                             '<7 hours', 
                                       ifelse(fmult[[j]]$sleep_hours >= 7 & 
                                                fmult[[j]]$sleep_hours <= 9, 
                                              '7-9 hours',
                                              '>9 hours'))

fmult[[j]]$sleep_hours_categorical <- factor(fmult[[j]]$sleep_hours_categorical, 
                                            levels = c('<7 hours',
                                                       '7-9 hours',
                                                       '>9 hours'),
                                            ordered = FALSE)

fmult[[j]]$sleep_hours_categorical <- relevel(fmult[[j]]$sleep_hours_categorical, 
                                              ref = '7-9 hours')

# education years
fmult[[j]]$education_years <- ifelse(fmult[[j]]$education_college == 'Yes', 
                                     '20 years', 
                               ifelse(fmult[[j]]$education_NVQ == 'Yes', 
                                      '19 years', 
                                      ifelse(fmult[[j]]$education_other_professional == 'Yes', 
                                             '15 years', 
                                             ifelse(fmult[[j]]$education_A_levels == 'Yes', 
                                                    '13 years', 
                                                    ifelse(fmult[[j]]$education_O_levels == 'Yes' | 
                                                             fmult[[j]]$education_CSEs == 'Yes', 
                                                           '10 years',
                                                           ifelse(fmult[[j]]$education_none == 'Yes', 
                                                                  '7 years', 
                                                                  '7 years'))))))

fmult[[j]]$education_years <- factor(fmult[[j]]$education_years, 
                                    levels = c('7 years',
                                               '10 years',
                                               '13 years',
                                               '15 years',
                                               '19 years',
                                               '20 years'),
                                    ordered = FALSE)

fmult[[j]]$education_years <- relevel(fmult[[j]]$education_years, 
                                      ref = '7 years')

# hand grip strength normalized by body weight
fmult[[j]]$hand_grip_strength_left_normalized <- 
  (fmult[[j]]$hand_grip_strength_left / fmult[[j]]$weight)

fmult[[j]]$hand_grip_strength_right_normalized <- 
  (fmult[[j]]$hand_grip_strength_right / fmult[[j]]$weight)

# lung function standardized by height
fmult[[j]]$FEV1_standardized <- 
  (fmult[[j]]$FEV1_best / (fmult[[j]]$standing_height / 100)^2) # divide by 100 to get m instead of cm

fmult[[j]]$FVC_standardized <- 
  (fmult[[j]]$FVC_best / (fmult[[j]]$standing_height / 100)^2) # divide by 100 to get m instead of cm

}

# save
save(mult, 
     fmult,
     file = "/Users/austin.argentieri/OneDrive - Nexus365/DPhil Research/UKB/Datasets/8. Final imputed exposure datasets/final_imputed_ukb_datasets_with_derived_feb_2021.RData")
```